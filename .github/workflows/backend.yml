name: Backend CI/CD

on:
  push:
    branches: ["main"]
    paths:
      - "backend/**"
      - ".github/workflows/backend.yml"
    tags:
      - "backend-v*" # Escucha tags como: backend-v1.0.0
  workflow_dispatch:
    inputs:
      version:
        description: "Version tag (optional)"
        required: false
        type: string

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Generate version
        id: version
        run: |
          if [[ $GITHUB_REF == refs/tags/backend-v* ]]; then
            # OpciÃ³n 1: Es un Tag (backend-v1.0.0 -> v1.0.0)
            VERSION=${GITHUB_REF#refs/tags/backend-}
            echo "ðŸ·ï¸ Tag Release Detected: $VERSION"
            
          elif [[ -n "${{ github.event.inputs.version }}" ]]; then
            # OpciÃ³n 2: Manual Dispatch
            VERSION="${{ github.event.inputs.version }}"
            echo "ðŸ“¦ Manual Input: $VERSION"
            
          else
            # OpciÃ³n 3: Push automÃ¡tico (SHA)
            VERSION="$(date +%Y%m%d)-${GITHUB_SHA::7}"
            echo "ðŸš€ Auto Gen: $VERSION"
          fi
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT

      - name: Build and Deploy
        uses: ./.github/actions/docker-deploy
        with:
          application-name: backend
          docker-image: ${{ secrets.DOCKER_USERNAME }}/backend-api
          service-path: ./backend
          version: ${{ steps.version.outputs.VERSION }}
          docker-username: ${{ secrets.DOCKER_USERNAME }}
          docker-password: ${{ secrets.DOCKER_PASSWORD }}
          dokploy-token: ${{ secrets.DOKPLOY_TOKEN }}
          project-name: "flight_prediction"
          application-id: ${{ secrets.DOKPLOY_BACKEND_ID }}
