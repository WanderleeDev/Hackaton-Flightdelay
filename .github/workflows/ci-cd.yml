name: CI/CD Backend & Microservice

on:
  push:
    branches: [ "main" ]
    paths:
      - 'backend/**'
      - 'microservice/**'

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - service: backend
            path: backend
            image: wanderlee/backend-api
          - service: microservice
            path: microservice
            image: wanderlee/fastapi-service
    
    steps:
      - name: Checkout repo
        uses: actions/checkout@v3
        with:
          fetch-depth: 2
      
      - name: Check if service changed
        id: changed
        run: |
          if git diff --name-only HEAD~1 HEAD | grep -q "^${{ matrix.path }}/"; then
            echo "changed=true" >> $GITHUB_OUTPUT
          else
            echo "changed=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Set version
        if: steps.changed.outputs.changed == 'true'
        id: version
        run: echo "VERSION=$(date +%Y%m%d)-${GITHUB_SHA::7}" >> $GITHUB_OUTPUT
      
      - name: Login to Docker Hub
        if: steps.changed.outputs.changed == 'true'
        run: echo "${{ secrets.DOCKER_PASSWORD }}" | docker login -u "${{ secrets.DOCKER_USERNAME }}" --password-stdin
      
      - name: Build & Push Docker Image
        if: steps.changed.outputs.changed == 'true'
        run: |
          docker build -t ${{ matrix.image }}:${{ steps.version.outputs.VERSION }} ./${{ matrix.path }}
          docker tag ${{ matrix.image }}:${{ steps.version.outputs.VERSION }} ${{ matrix.image }}:latest
          docker push ${{ matrix.image }}:${{ steps.version.outputs.VERSION }}
          docker push ${{ matrix.image }}:latest
      
      - name: Trigger Dokploy redeploy
        if: steps.changed.outputs.changed == 'true'
        run: |
          curl -X POST "https://dockploy.wanderlee.site/api/redeploy" \
          -H "Authorization: Bearer ${{ secrets.DOKPLOY_TOKEN }}" \
          -H "Content-Type: application/json" \
          -d '{"service":"${{ matrix.service }}","version":"${{ steps.version.outputs.VERSION }}"}'