name: Microservice CI/CD

on:
  push:
    branches: ["main"]
    paths:
      - "microservice/**"
      - ".github/workflows/microservice.yml"
    tags:
      - "microservice-v*"
  workflow_dispatch:
    inputs:
      version:
        description: "Version tag (optional)"
        required: false
        type: string

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Generate version
        id: version
        run: |
          if [[ $GITHUB_REF == refs/tags/microservice-v* ]]; then
             # microservice-v1.0.0 -> v1.0.0
             VERSION=${GITHUB_REF#refs/tags/microservice-}
             echo "ðŸ·ï¸ Tag Release Detected: $VERSION"
             
          elif [[ -n "${{ github.event.inputs.version }}" ]]; then
             VERSION="${{ github.event.inputs.version }}"
             echo "ðŸ“¦ Manual Input: $VERSION"
             
          else
             VERSION="$(date +%Y%m%d)-${GITHUB_SHA::7}"
             echo "ðŸš€ Auto Gen: $VERSION"
          fi
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT

      - name: Build and Deploy
        uses: ./.github/actions/docker-deploy
        with:
          service-name: microservice
          docker-image: ${{ secrets.DOCKER_USERNAME }}/fastapi-service
          service-path: ./microservice
          version: ${{ steps.version.outputs.VERSION }}
          docker-username: ${{ secrets.DOCKER_USERNAME }}
          docker-password: ${{ secrets.DOCKER_PASSWORD }}
          dokploy-token: ${{ secrets.DOKPLOY_TOKEN }}
